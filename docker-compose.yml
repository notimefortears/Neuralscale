services:
  redpanda:
    image: redpandadata/redpanda:v24.2.7
    command:
      - redpanda
      - start
      - --overprovisioned
      - --smp
      - "1"
      - --memory
      - "1G"
      - --reserve-memory
      - "0M"
      - --node-id
      - "0"
      - --kafka-addr
      - PLAINTEXT://0.0.0.0:9092
      - --advertise-kafka-addr
      - PLAINTEXT://redpanda:9092
    ports:
      - "9092:9092"
    healthcheck:
      test: ["CMD-SHELL", "bash -lc 'exec 3<>/dev/tcp/127.0.0.1/9092'"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 10s

  postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: neuralscale
      POSTGRES_PASSWORD: neuralscale
      POSTGRES_DB: neuralscale
    ports:
      - "55432:5432"
    volumes:
      - ./infra/db/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U neuralscale -d neuralscale"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 10s

  neo4j:
    image: neo4j:5.23.0
    ports:
      - "7474:7474"
      - "7687:7687"
    environment:
      NEO4J_AUTH: neo4j/neuralscale
    healthcheck:
      test: ["CMD-SHELL", "bash -lc 'exec 3<>/dev/tcp/127.0.0.1/7687'"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 20s

  redis:
    image: redis:7
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 5s

  ingestion:
    build:
      context: .
      dockerfile: services/ingestion/Dockerfile
    environment:
      KAFKA_BOOTSTRAP: redpanda:9092
      TOPIC_RAW_EVENTS: raw_threat_events
      CONNECTOR_INTERVAL_SEC: "30"
    depends_on:
      redpanda:
        condition: service_healthy

  processor:
    build:
      context: .
      dockerfile: services/processor/Dockerfile
    environment:
      KAFKA_BOOTSTRAP: redpanda:9092

      # IMPORTANT: this is what your processor code reads
      KAFKA_TOPIC_RAW: raw_threat_events

      # if you have an enriched producer later
      KAFKA_TOPIC_ENRICHED: enriched_threat_events

      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: neuralscale

      PG_DSN: postgresql://neuralscale:neuralscale@postgres:5432/neuralscale
    depends_on:
      redpanda:
        condition: service_healthy
      neo4j:
        condition: service_healthy
      postgres:
        condition: service_healthy

  api:
    build:
      context: .
      dockerfile: services/api/Dockerfile
    environment:
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: neuralscale
      PG_DSN: postgresql://neuralscale:neuralscale@postgres:5432/neuralscale
      REDIS_URL: redis://redis:6379/0
    ports:
      - "8000:8000"
    depends_on:
      neo4j:
        condition: service_healthy
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
